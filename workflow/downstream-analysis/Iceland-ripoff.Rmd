---
title: "Spread of COVID-19 in the Danish population"
author: "The Corona Danica Consortium (CDC)"
date: "`r format(Sys.time(), '%d-%m-%Y')`, Aalborg, Denmark"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(ggplot2)
library(scales)
library(cowplot)

library(tidyverse)
library(data.table)
library(rjson)

library(pegas)

### Load the metadata. #########################################################
# Read in metadata - from /srv/rbd/covid19/data/COVID19/analysis/nextstrain-analysis/data/
meta   <- fread("metadata.tsv",sep = "\t")

# Info on clade membership - from /srv/rbd/covid19/data/COVID19/analysis/nextstrain-analysis/results/
clades <- fromJSON(file = "clades.json") %>%
  .$nodes %>%
  sapply("[[",1) %>%
  {data.table(strain = names(.),Clade = .,row.names = NULL)}

# nt and aa mutations - from /srv/rbd/covid19/data/COVID19/analysis/nextstrain-analysis/results/
nt      <- fromJSON(file = "nt_muts.json")$nodes
nt_seqs <- lapply(nt,"[[",2)
nt_muts <- sapply(nt,"[[",1) %>% 
  sapply(paste0,collapse = ",") %>% 
  {data.table(strain = names(.),nt_muts = .,row.names = NULL)}
rm(nt)

aa_muts <- fromJSON(file = "aa_muts.json") %>%
  .$nodes %>%
  lapply("[[",1) %>%
  lapply(lapply,paste0,collapse = ",") %>% 
  rbindlist(idcol = "strain")

dat <- merge(clades,nt_muts,by = "strain") %>%
  merge(.,aa_muts,by = "strain") %>%
  merge(.,meta,by = "strain",all.x = T)

```

# Take-homes

* Our samples only include members from the A2a clade, thats suspicious. But again - limited data. Need to be sure its not some bias. We might to go into the detail and see if some specific positions are mutated in ONLY our samples...
* Need to find out what to do with haplotype plots, up for suggestions. But with metadata things might start to make sense...

# DK samples (our samples)

## Cumulative haplotype frequency

The cumulative haplotype frequency. (A) For all data and (B) for Danish samples only.

```{r}
haplo_lvl <- sort(unique(dat$Clade)) %>%
  {setNames(hue_pal()(length(.)),nm = .)}

cumhap_all <- dat %>% 
  .[!is.na(date) & !grepl("XX",date)] %>%
  .[,n := 1] %>%
  .[,c("date","n","Clade")] %>%
  .[,.(n = sum(n)),by = .(date,Clade)] %>%
  complete(date,nesting(Clade),fill = list(n = 0)) %>%
  mutate(Clade = factor(Clade,levels = names(haplo_lvl))) %>%
  group_by(Clade) %>%
  arrange(as.numeric(as.Date(date))) %>%
  mutate(cs = cumsum(n))

cumhap_DK <- dat[country == "Denmark"] %>% 
  .[!is.na(date) & !grepl("XX",date)] %>%
  .[,n := 1] %>%
  .[,c("date","n","Clade")] %>%
  .[,.(n = sum(n)),by = .(date,Clade)] %>%
  complete(date,nesting(Clade),fill = list(n = 0)) %>%
  mutate(Clade = factor(Clade,levels = names(haplo_lvl))) %>%
  group_by(Clade) %>%
  arrange(as.numeric(as.Date(date))) %>%
  mutate(cs = cumsum(n))

# Plot. 
p_all <- ggplot(cumhap_all,aes(x = as.Date(date),y = cs,fill = Clade)) +
  geom_area() + 
  labs(fill = "Haplotype",x = "Date",y = "Cumulative count",title = "All data") +
  scale_fill_manual(values = haplo_lvl) +
  scale_x_date(labels = date_format("%Y-%m-%d")) + 
  theme(
    legend.position = "none",
    axis.text.x     = element_text(angle = 45,hjust = 1))

p_DK <- ggplot(cumhap_DK,aes(x = as.Date(date),y = cs,fill = Clade)) +
  geom_area() + 
  labs(fill = "Haplotype",x = "Date",y = "Cumulative count",title = "DK only") +
  scale_fill_manual(values = haplo_lvl) +
  scale_x_date(labels = date_format("%Y-%m-%d")) + 
  theme(
    legend.position = "none",
    axis.text.x     = element_text(angle = 45,hjust = 1))

leg <- get_legend(p_all + theme(legend.position = "bottom"))

p <- plot_grid(p_all,p_DK,labels = c("(A)","(B)"))
plot_grid(p,leg,rel_heights = c(1,.2),nrow = 2)
```

## Haplotype networks

Below I've plotted the haplotype network for our data only (takes forever with the whole dataset...). Each circle represents a specific sequence, the size is scaled according to number of sequences and coloured according to location. For at quick tutorial of how to interpret such plots look [here](https://markscherz.tumblr.com/post/80597912898/haplotypes-and-understanding-haplotype-networks). Im not completely sure what to make of this yet, but looks cool! Note that I just made up the locations.

```{r}
# Use only DK samples.
wh_DK <- dat[country == "Denmark" & location != ""]$strain

# Extract sequences in correct format.
seqs <- nt_seqs[wh_DK] %>%
  lapply(function(x){strsplit(x,split = "")[[1]]}) %>%
  as.DNAbin() %>%
  as.matrix()

# Find haplotypes.
seqsHaps <- haplotype(seqs)
seqsHaps <- sort(seqsHaps,what = "label")

# Construct haplotype network.
seqsNet <- haploNet(seqsHaps)

# Map to location.
for_pie <- stack(setNames(attr(seqsHaps,"index"), rownames(seqsHaps))) %>%
  {mutate(.,strain = rownames(seqs)[.$values])} %>%
  left_join(.,dat,by = "strain") %>%
  mutate(location = ifelse(location == "","N/A",location)) %>%
  with(.,table(hap = ind,pop = location))

par(mar = c(0,0,0,0))
plot(seqsNet, size = attr(seqsNet,"freq"), fast = TRUE,pie = for_pie,scale.ratio=2)
legend("bottomright", colnames(for_pie), col=rainbow(ncol(for_pie)), pch=19, ncol=2)
```

# Netherland samples (for comparison)

## Cumulative haplotype frequency

The cumulative haplotype frequency. (A) For all data and (B) for Danish samples only.

```{r}
haplo_lvl <- sort(unique(dat$Clade)) %>%
  {setNames(hue_pal()(length(.)),nm = .)}

cumhap_all <- dat %>% 
  .[!is.na(date) & !grepl("XX",date)] %>%
  .[,n := 1] %>%
  .[,c("date","n","Clade")] %>%
  .[,.(n = sum(n)),by = .(date,Clade)] %>%
  complete(date,nesting(Clade),fill = list(n = 0)) %>%
  mutate(Clade = factor(Clade,levels = names(haplo_lvl))) %>%
  group_by(Clade) %>%
  arrange(as.numeric(as.Date(date))) %>%
  mutate(cs = cumsum(n))

cumhap_DK <- dat[country == "Netherlands"] %>% 
  .[!is.na(date) & !grepl("XX",date)] %>%
  .[,n := 1] %>%
  .[,c("date","n","Clade")] %>%
  .[,.(n = sum(n)),by = .(date,Clade)] %>%
  complete(date,nesting(Clade),fill = list(n = 0)) %>%
  mutate(Clade = factor(Clade,levels = names(haplo_lvl))) %>%
  group_by(Clade) %>%
  arrange(as.numeric(as.Date(date))) %>%
  mutate(cs = cumsum(n))

# Plot. 
p_all <- ggplot(cumhap_all,aes(x = as.Date(date),y = cs,fill = Clade)) +
  geom_area() + 
  labs(fill = "Haplotype",x = "Date",y = "Cumulative count",title = "All data") +
  scale_fill_manual(values = haplo_lvl) +
  scale_x_date(labels = date_format("%Y-%m-%d")) + 
  theme(
    legend.position = "none",
    axis.text.x     = element_text(angle = 45,hjust = 1))

p_DK <- ggplot(cumhap_DK,aes(x = as.Date(date),y = cs,fill = Clade)) +
  geom_area() + 
  labs(fill = "Haplotype",x = "Date",y = "Cumulative count",title = "DK only") +
  scale_fill_manual(values = haplo_lvl) +
  scale_x_date(labels = date_format("%Y-%m-%d")) + 
  theme(
    legend.position = "none",
    axis.text.x     = element_text(angle = 45,hjust = 1))

leg <- get_legend(p_all + theme(legend.position = "bottom"))

p <- plot_grid(p_all,p_DK,labels = c("(A)","(B)"))
plot_grid(p,leg,rel_heights = c(1,.2),nrow = 2)
```

## Haplotype networks

Below I've plotted the haplotype network for Netherland data, only samples with a location specified are included. Each circle represents a specific sequence, the size is scaled according to number of sequences and coloured according to location. For at quick tutorial of how to interpret such plots look [here](https://markscherz.tumblr.com/post/80597912898/haplotypes-and-understanding-haplotype-networks). I haven't included the legend, not important - just to show that up-front it looks kinda similar.

```{r}
# Use only DK samples.
wh_DK <- dat[country == "Netherlands" & location != ""]$strain

# Extract sequences in correct format.
seqs <- nt_seqs[wh_DK] %>%
  lapply(function(x){strsplit(x,split = "")[[1]]}) %>%
  as.DNAbin() %>%
  as.matrix()

# Find haplotypes.
seqsHaps <- haplotype(seqs)
seqsHaps <- sort(seqsHaps,what = "label")

# Construct haplotype network.
seqsNet <- haploNet(seqsHaps)

# Map to location.
for_pie <- stack(setNames(attr(seqsHaps,"index"), rownames(seqsHaps))) %>%
  {mutate(.,strain = rownames(seqs)[.$values])} %>%
  left_join(.,dat,by = "strain") %>%
  mutate(location = ifelse(location == "","N/A",location)) %>%
  with(.,table(hap = ind,pop = location))

par(mar = c(0,0,0,0))
plot(seqsNet, size = attr(seqsNet,"freq"), fast = TRUE,pie = for_pie,scale.ratio=2)
legend("bottomright", colnames(for_pie), col=rainbow(ncol(for_pie)), pch=19, ncol=2)
```
